{% extends "base.html.j2" %}

{% block header_extras %}
        <meta charset="UTF-8">
        <link rel="stylesheet" href="https://assets.emblstatic.net/vf/v2.5.8/css/styles.css">
        <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
        <link rel="stylesheet" type="text/css" href="https://cdn.datatables.net/v/dt/dt-1.11.5/datatables.min.css"/>
        <script type="text/javascript" src="https://cdn.datatables.net/v/dt/dt-1.11.5/datatables.min.js"></script>
        <script type="text/javascript" src="https://cdn.datatables.net/plug-ins/1.13.1/sorting/natural.js"></script>
        <script src="https://kit.fontawesome.com/1d1848da05.js" crossorigin="anonymous"></script>
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
        <meta charset="UTF-8">
        <style>
        .help {
          cursor: help;
          }
        .section-spacing {
            border-bottom: 1px solid #ccc;
            padding-bottom: 20px; /* Adjust as needed for spacing */
            margin-bottom: 20px; /* Adjust as needed for spacing */
        }
                /* Add class to shrink table layout when columns are hidden */
        .shrink-table {
            table-layout: fixed;
            min-width: 600px;
            width: auto !important; 
        }
        /* Add classes to hide columns in the table */
        .hidden {
            display: none;
        }
        .wrapper {
          max-width: 1200px; 
        }
        .shrunk{
          width: 50% !important; 
        }
        /* Set a fixed width for cell content */
        .cell-content {
            width: 100px; /* Adjust as needed */
            overflow: hidden;
            white-space: nowrap;
            text-overflow: ellipsis; /* Truncate long content with ellipsis */
        }
        </style>
{% endblock %}

{% block title %} {{ accession_id }} {% endblock %}

{% block content %}
<section class="vf-intro">

  <div><!-- empty --></div>

  <div class="vf-stack">
  <h1 class="vf-intro__heading vf-intro__heading--has-tag">{{ study.accession_id }}<a href="JavaScript:Void(0);" class="vf-badge vf-badge--primary vf-badge--phases">alpha</a></h1>
  <h2 class="vf-intro__subheading">{{ study.title }}</h2>
     Released: {{ study.release_date }} <br>
    By: {{ authors }}
  </div>
</section>

<section class="embl-grid">
    <h3 class="vf-links__heading">On this page</h3>
    <div class="vf-links vf-links__list--easy">
      <ul class="vf-links__list | vf-list">
        <li class="vf-list__item">
          <a class="vf-list__link" href="#study">
            Study Information
            <svg class="vf-icon vf-icon__arrown--down | vf-list__icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M.249,7.207,11.233,19.678h0a1.066,1.066,0,0,0,1.539,0L23.751,7.207a.987.987,0,0,0-.107-1.414l-1.85-1.557a1.028,1.028,0,0,0-1.438.111L12.191,13.8a.25.25,0,0,1-.379,0L3.644,4.346A1.021,1.021,0,0,0,2.948,4a1,1,0,0,0-.741.238L.356,5.793A.988.988,0,0,0,0,6.478.978.978,0,0,0,.249,7.207Z"></path></svg>
          </a>
        </li>
        <li class="vf-list__item">
          <a class="vf-list__link" href="#images">
            Images
            <svg class="vf-icon vf-icon__arrown--down | vf-list__icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M.249,7.207,11.233,19.678h0a1.066,1.066,0,0,0,1.539,0L23.751,7.207a.987.987,0,0,0-.107-1.414l-1.85-1.557a1.028,1.028,0,0,0-1.438.111L12.191,13.8a.25.25,0,0,1-.379,0L3.644,4.346A1.021,1.021,0,0,0,2.948,4a1,1,0,0,0-.741.238L.356,5.793A.988.988,0,0,0,0,6.478.978.978,0,0,0,.249,7.207Z"></path></svg>
          </a>
        </li>
        <li class="vf-list__item">
          <a class="vf-list__link" href="#annotations">
            Annotations
            <svg class="vf-icon vf-icon__arrown--down | vf-list__icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M.249,7.207,11.233,19.678h0a1.066,1.066,0,0,0,1.539,0L23.751,7.207a.987.987,0,0,0-.107-1.414l-1.85-1.557a1.028,1.028,0,0,0-1.438.111L12.191,13.8a.25.25,0,0,1-.379,0L3.644,4.346A1.021,1.021,0,0,0,2.948,4a1,1,0,0,0-.741.238L.356,5.793A.988.988,0,0,0,0,6.478.978.978,0,0,0,.249,7.207Z"></path></svg>
          </a>
        </li>
        <li class="vf-list__item">
          <a class="vf-list__link" href="#models">
            Models used
            <svg class="vf-icon vf-icon__arrown--down | vf-list__icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M.249,7.207,11.233,19.678h0a1.066,1.066,0,0,0,1.539,0L23.751,7.207a.987.987,0,0,0-.107-1.414l-1.85-1.557a1.028,1.028,0,0,0-1.438.111L12.191,13.8a.25.25,0,0,1-.379,0L3.644,4.346A1.021,1.021,0,0,0,2.948,4a1,1,0,0,0-.741.238L.356,5.793A.988.988,0,0,0,0,6.478.978.978,0,0,0,.249,7.207Z"></path></svg>
          </a>
        </li>
        <li class="vf-list__item">
          <a class="vf-list__link" href="https://uk1s3.embassy.ebi.ac.uk/bia-integrator-data/pages/access_data_help.html">
            How to access the data
            <svg class="vf-icon vf-icon__arrown--down | vf-list__icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M.249,7.207,11.233,19.678h0a1.066,1.066,0,0,0,1.539,0L23.751,7.207a.987.987,0,0,0-.107-1.414l-1.85-1.557a1.028,1.028,0,0,0-1.438.111L12.191,13.8a.25.25,0,0,1-.379,0L3.644,4.346A1.021,1.021,0,0,0,2.948,4a1,1,0,0,0-.741.238L.356,5.793A.988.988,0,0,0,0,6.478.978.978,0,0,0,.249,7.207Z"></path></svg>
          </a>
        </li>
      </ul>
    </div>
  </section>

  <div class="embl-grid embl-grid--has-centered-content">
    <div class="vf-section-header">
      <h2 class="vf-section-header__heading">
      In a nutshell
      </h2>
<ul class="vf-list">
        <li>{{ study.images|length }} images</li>
        {% if annotation_names|length > 0 %}
        <li>{{ annotation_names|length }} annotations</li>
        {% endif %}
        {% if study.archive_files|length > 0 %}
        <li>{{ study.archive_files|length }} archive files</li>
        {% endif %}
        {% if study.other_files|length > 0 %}
       <li>{{ study.other_files|length }} other files</li>
        {% endif %}
        {% if "n_files_in_study" in study.attributes %}
        <li>Study size: {{ study.attributes["study_size"] }}</li>
        <!-- <li>No of files in study: {{ study.attributes["n_files_in_study"] }}</li> -->
        <li>Filetype breakdown: {{ study.attributes["filetype_breakdown_html"] }}</li>
        {% endif %}
        <li><b>License : {{ study.license }} </b><li>
        </ul>
        <h2 class="vf-section-header__heading">This dataset has</h2>
        <ul class="vf-list">
        {% if study.attributes.get('annotation_type') %}
        {% for value in study.attributes['annotation_type'].split(',') %}
        <li>{{ value }}</li>
        {% endfor %}
        {% endif %}
        {% for value in study.tags %}
        {% if value.startswith('AI') %}
        <li>{{ value[2:] }}</li>
        {% else %}
        <li>{{ value }}</li>
        {% endif %}
        {% endfor %}
        </ul>
        {% if 'bia_binder_url' in study.attributes %}
            <a href={{ study.attributes['bia_binder_url'] }}><button class="vf-button vf-button--primary vf-button--sm">Explore in BIA Binder</button></a>
        {% endif %}
    </div>
      <div>
    <table class="vf-table--striped">
    <colgroup>
      <col span="1" style="width: 50%;">
      <col span="1" style="width: 50%;">                         
    </colgroup>
    <tr class="vf-table__row">  
    <td class="vf-table__cell">             
      <figure class="vf-figure">
        <img class="vf-figure__image" src="{{ study.example_image_uri }}" alt="Example image for this dataset">
        <figcaption class="vf-figure__caption">Example image for this dataset</figcaption>
      </figure> 
      </td> 
    <td class="vf-table__cell">
      <figure class="vf-figure">
        <img class="vf-figure__image" src="{{ study.example_annotation_uri }}" alt="Example annotation for this dataset">
        <figcaption class="vf-figure__caption">Example annotation for this dataset</figcaption>
      </figure>
    </td>
    </tr> 
    </table>
      </div>

  </div>

    <!-- Study Information --> 
  <section class="embl-grid embl-grid--has-centered-content section-spacing">
    <div class="vf-section-header">
      <h3 class="vf-section-header__heading" id="study">Study Information</h3>
      <p></p>
      <a class="vf-card__link" href="https://www.ebi.ac.uk/biostudies/BioImages/studies/{{ study.accession_id }}" target=”_blank”><button class="vf-button vf-button--primary vf-button--sm">Original submission page</button></a>
     <!--  <a class="vf-card__link" href="https://www.ebi.ac.uk/biostudies/BioImages/studies/{{ study.accession_id }}" target=”_blank”> Original submission page </a> -->
    </div>
    <div class="vf-content">
      <div class="vf-grid vf-grid__col-2">
            {% if study.attributes.get('one_summary') %}
            <div><b>Study Summary</b></div>
            <div>{{ study.attributes["one_summary"] }}</div>
            {% endif %}
            <!-- {% if study.attributes.get('annotation_summary') %}
            <div><b>Annotation Summary</b></div>
            <div>{{ study.attributes["annotation_summary"] }}</div>
            {% endif %} -->
           <div><b>Organism</b></div>
            <div>{{ study.organism }}</div>
          <!--  <div><b>Study type</b></div>
            <div>{{ study.attributes["study_type"] }}</div> -->
            <div><b>Imaging type</b></div>
            <div>{{ study.imaging_type }}</div>
        </div>
    </div>
  </section>

<p></p>
        
    <!-- Images -->
    <section class="vf-content | embl-grid embl-grid--has-centered-content section-spacing">
    <div> 
      <h2 class="vf-section-header__heading" id="images">Viewable images 
      <i class="fa-solid fa-circle-info" title="Images that have been converted to ome-ngff for in-browser viewing"></i>
      </h2> 
    </div>
    <div>
    <div class="btn-group" role="group" aria-label="Show/Hide Columns">
      <button class="vf-button--small" id="toggle-images-column-2">Show/Hide Filename</button>
      <button type="button" class="btn btn-primary" id="toggleButton" style="float: right;">Expand/Shrink Table</button>
    </div>
      <div id="table_wrapper" class="wrapper" style="display: block">                
                    <table id="viewable">
                        {# <caption class="vf-table__caption">Images with OME-NGFF representations</caption> #}
                        {# <colgroup>
                              <col span="1" style="width: 20%;">
                              <col span="1" style="width: 40%;">
                              <col span="1" style="width: 30%;">
                              <col span="1" style="width: 10%;">
                        </colgroup> #}
                        <thead>
                            <tr>
                                <th>Image ID</th>
                                <th>Preview</th>
                                {% if corresponding_ann_aliases %}
                                <th>Corresponding Annotation ID</th>
                                {% endif %}
                                <th>Filename <i class="fa-solid fa-circle-info" title="Orginial filepath and filename prior to ome-ngff conversion"></i></th>
                                <th>Dimensions<br>(T, C, Z, Y, X)</th>
                                <th>Download Size</th>
                                <th>Actions <i class="fa-solid fa-circle-info" title="view will open the ome-ngff image in-browser, download will download the image in its original unconverted format"></i></th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for image in images %}
                            <tr>
                                {% if image_ann_aliases.get(image.id) %}
                                <td>{{ image_names[image.id] }},{{ image_ann_aliases[image.id] }}</td>
                                {% else %}
                                <td>{{ image_names[image.id] }}</td>
                                
                                {% endif %}
                                <td>
                                  <div class="cell-content">
                                    <img class="vf-figure__image" src={{ image_thumbnails[image.id] }}>
                                    </div>
                                </td>
                                {% if corresponding_ann_aliases %}
                                  {% if corresponding_ann_aliases.get(image.id) %}
                                  <td>{{ corresponding_ann_aliases[image.id] }}</td>
                                  {% else %}
                                  <td>  </td>
                                  {% endif %}
                                {% endif %}
                                <td>{{ image.original_relpath }}</td>
                                {% if image.dimensions %}
                                    <td>{{ image.dimensions }}</td>
                                {% elif image.attributes.get('SizeX') %}
                                    <td> ({{ image.attributes['SizeT'] }}, {{ image.attributes['SizeC'] }}, {{ image.attributes['SizeZ'] }}, {{ image.attributes['SizeY'] }}, {{ image.attributes['SizeX'] }})</td>
                                {% else %}
                                    <td> None </td>
                                {% endif %}
                                {% if "download_size" in image.attributes %}
                                    <td>{{ image.attributes["download_size"] }}</td>
                                {% else %}
                                    <td>Unavailable</td>
                                {% endif %}
                                <td>
                                    <a href={{ landing_uris[image.id] }}><button class="vf-button vf-button--sm vf-button--icon">view</button><a>
                                    <a href={{ image_download_uris[image.id] }}><button class="vf-button vf-button--sm vf-button--icon">download</button></a>
                                </td>                            
                            </tr>
                            {% endfor %}
                        </tbody>
                      </table>
                    </div>
                    </div>
                    
                    <div>
                    </div>
            </section>

    <!-- Annotations --> 
  <section class="embl-grid embl-grid--has-centered-content section-spacing">
    <div class="vf-section-header">
      <h3 class="vf-section-header__heading" id="annotations">Annotations
      <i class="fa-solid fa-circle-info" title="Annotation in the context of AI, is the task of marking up data, such as images, so it can be recognised by models and used to make predictions."></i></h3>
      <ul class="vf-list">
        {% if study.attributes.get('annotation_type') %}
        <li><b><a href='https://uk1s3.embassy.ebi.ac.uk/bia-integrator-data/pages/ai-glossary.html' target=”_blank”>Annotation type(s)</a>:</b><i class="fa-solid fa-circle-info" title="Click on the Annotation type(s) to go to the page with a glossary"></i>
        {{ study.attributes['annotation_type'] }}</li>
        {% endif %}
        {% if study.attributes.get('annotation_method') %}
        <li><b>Annotation method(s):</b> {{ study.attributes['annotation_method'] }}</li>
        {% endif %}
    </div>
    <div class="vf-content">
        <div class="btn-group" role="group" aria-label="Show/Hide Columns">
              <button type="button" class="btn btn-primary" id="toggle-annot-column-2">Show/Hide Filename</button>
              <button type="button" class="btn btn-primary" id="toggle-annot-column-3">Show/Hide Source Image</button>
        </div>
            <table class="display table" id="annot_table">
                        <thead>
                            <tr>
                                <th>Annotation ID</th>
                                {% if corresponding_im_aliases %}
                                <th>Corresponding Image ID</th>
                                {% endif %}
                                <th>Filename</th>
                                {% if annotation_names %}
                                <th>Source Image</th>
                                {% endif %}
                                <th>Download Size</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for annfile in annotation_names %}
                                {% if annfile.attributes.get('alias')%}
                                <td>{{ annfile.attributes['alias']}} </td>
                                {% else %}
                                <td>{{ annfile.id }}</td>
                                {% endif %}
                                {% if corresponding_im_aliases %}
                                  {% if corresponding_im_aliases.get(annfile.attributes['alias']) %}
                                  <td>{{ corresponding_im_aliases[annfile.attributes['alias']] }}</td>
                                  {% else %}
                                  <td>  </td>
                                {% endif %}
                                {% endif %}
                                <td>{{ annfile.name }}</td>
                                 {% if annfile.attributes.get('source image') %}
                                <td>{{ annfile.attributes['source image'] }}</td>
                                {% endif %}
                                {% if annfile.attributes.get('download_size') %}
                                    <td>{{ annfile.attributes["download_size"] }}</td>
                                {% else %}
                                    <td>Unavailable</td>
                                {% endif %}
                                <td><a href={{ annotation_download_uris[annfile.id] }}>Download</a></td>
                            </tr>
                            {% endfor %}
                        </tbody>
                      </table>  
        </div>
    </div>
  </section>

    <!-- Models used --> 
  <section class="embl-grid embl-grid--has-centered-content section-spacing">
    <div class="vf-section-header">
    <h3 class="vf-section-header__heading" id="models">Models <i class="fa-solid fa-circle-info" title="Models can mean two things: models that are used to derive the annotations in this study, OR this dataset is used to train these models"></i></h3>
    </div>
    <div class="vf-content">
    {% if study.attributes.get('models_uri') or study.attributes.get('models_description')%}
      {% if study.attributes.get('models_description') %}
        <li><b>Model description:</b> {{ study.attributes['models_description'] }}</li>
      {% endif %}
      {% if study.attributes.get('models_uri') %}
        <li><b>Model link:</b> <a href={{ study.attributes['models_uri'] }}>{{ study.attributes['models_uri'] }}</a> </li>
      {% endif %} 
    {% else %}
      {% for k,v in study.links.items() %}
      {% if 'model' in k or 'code' in k %}
        <div>  {{ k }} :  <a href={{ v }}> {{ v }} </a></div>
      {% endif %}
      {% endfor %} 
      {% endif %}
      <br>
        </div>
    </div>
  </section>

        <!-- All Images -->
        <section class="embl-grid embl-grid--has-centered-content section-spacing">
                    <div class="vf-section-header">
                      <h2 class="vf-section-header__heading">All images <i class="fa-solid fa-circle-info" title="All images in the study in their original format"></i></h2>
                    </div>
                    <div class="vf-content">
                      <div id="table_wrapper" class="wrapper" style="display: block"> 
                      <table class="display table" id="table">
                        <thead>
                            <tr>
                                <th>Image ID</th>
                                {% if corresponding_ann_aliases %}
                                <th>Corresponding Annotation ID</th>
                                {% endif %}
                                <th>Filename</th>
                                <th>Download Size</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                          {% for image in study.images.values() %}
                          <td>{{ image_names[image.id] }}</td>
                          {% if corresponding_ann_aliases %}
                            {% if corresponding_ann_aliases.get(image.id) %}
                            <td>{{ corresponding_ann_aliases[image.id] }}</td>
                            {% else %}
                            <td>  </td>
                            {% endif %}
                          {% endif %}
                          <td>{{ image.original_relpath }}</td>
                          {% if "download_size" in image.attributes %}
                          <td>{{ image.attributes["download_size"] }}</td>
                          {% else %}
                          <td>Unavailable</td>
                          {% endif %}
                          <td><a href={{ image_download_uris[image.id] }}>Download</a></td>
                          </tr>
                          {% endfor %}
                        </tbody>
                      </table> 
                      </div>                     
                      </div>
                    </div>
            </section>


        <script>
            $(document).ready( function () {
                $('#table').DataTable( {
                    scrollX: true,
                    columnDefs: [
                        { type: 'natural', targets: 0 }
                    ]
                });
          
                var annotTable = $('#annot_table').DataTable( {
                    columnDefs: [
                        { type: 'natural', width: '10%', targets: 0 },
                        { targets: [2, 3], visible: false }
                    ]
                });
            
                var imagesTable = $('#viewable').DataTable( {
                    scrollX: true,
                    columnDefs: [
                        { type: 'natural', width: '10%', targets: 0 },
                        { targets: 3, visible: false }
                    ]
                });

                // Toggle button click event
                $("#toggleButton").click( function() {
                  $("#table_wrapper").toggleClass("shrunk");
                });     

                // Toggle button for column 3 and column 4 in annot_table
                $('#toggle-annot-column-2').on('click', function () {
                    var column = annotTable.column(2);
                    column.visible(!column.visible());
                    $('#annot_table').toggleClass('shrink-table');
                    annotTable.columns.adjust().draw();
                });

                $('#toggle-annot-column-3').on('click', function () {
                    var column = annotTable.column(3);
                    column.visible(!column.visible());
                    $('#annot_table').toggleClass('shrink-table');
                    annotTable.columns.adjust().draw();
                });

                // Toggle button for column 3 in viewable table (images)
                $('#toggle-images-column-2').on('click', function () {
                    var column = imagesTable.column(3);
                    column.visible(!column.visible());
                    $('#viewable').toggleClass('shrink-table');
                    imagesTable.columns.adjust().draw();
                });

            } );
        </script>
{% endblock %}